
# Validate Version Workflow
name: "Validate Version"


on:
  workflow_call:
    inputs:
      working-directory:
        description: "Path to the uni_app working directory"
        required: false
        type: string
        default: ./packages/uni_app
      android_track:
        description: "Google Play track to query (internal, beta, production)"
        required: false
        type: string
        default: beta
      ios_channel:
        description: "iOS source to query (testflight, appstore)"
        required: false
        type: string
        default: testflight
    secrets:
      google_service_account_json:
        description: "Google service account JSON for Play Console"
        required: true
      asc_key_id:
        description: "App Store Connect API Key ID"
        required: true
      asc_issuer_id:
        description: "App Store Connect Issuer ID"
        required: true
      asc_key_content:
        description: "App Store Connect API Key content (p8)"
        required: true
    outputs:
      current_version:
        description: "Version read from app_version.txt"
        value: ${{ jobs.validate.outputs.current_version }}
      build_number:
        description: "Build number parsed from version"
        value: ${{ jobs.validate.outputs.build_number }}
      android_store_build_number:
        description: "Latest Android beta build number from Play Console"
        value: ${{ jobs.validate.outputs.android_store_build_number }}
      ios_store_build_number:
        description: "Latest iOS build number from selected channel"
        value: ${{ jobs.validate.outputs.ios_store_build_number }}


jobs:
  validate:
    name: "Validate Version"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    outputs:
      current_version: ${{ steps.read_version.outputs.CURRENT_VERSION }}
      build_number: ${{ steps.read_version.outputs.BUILD_NUMBER }}
      android_store_build_number: ${{ steps.android_store.outputs.ANDROID_STORE_BUILD_NUMBER }}
      ios_store_build_number: ${{ steps.ios_store.outputs.IOS_STORE_BUILD_NUMBER }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read Current Version
        id: read_version
        run: |
          # Read version from app_version.txt and extract build number
          FULL_VERSION=$(cat app_version.txt)
          echo "CURRENT_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
          BUILD_NUMBER=$(echo "$FULL_VERSION" | cut -d'+' -f2)
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ${{ inputs.working-directory }}

      - name: Get Latest Android Store Version
        id: android_store
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.google_service_account_json }}
        run: |
          echo "$GOOGLE_SERVICE_ACCOUNT_JSON" > /tmp/google_service_account.json
          export SUPPLY_JSON_KEY=/tmp/google_service_account.json
          ANDROID_BUILD=$(bundle exec fastlane run google_play_track_version_codes track:${{ inputs.android_track }} -q 2>/dev/null | grep -oE '[0-9]+' | head -1 || echo "0")
          echo "ANDROID_STORE_BUILD_NUMBER=$ANDROID_BUILD" >> $GITHUB_OUTPUT
          rm /tmp/google_service_account.json

      - name: Get Latest iOS Store Version
        id: ios_store
        env:
          ASC_KEY_ID: ${{ secrets.asc_key_id }}
          ASC_ISSUER_ID: ${{ secrets.asc_issuer_id }}
          ASC_KEY_CONTENT: ${{ secrets.asc_key_content }}
        run: |
          IOS_BUILD="0"
          if [ "${{ inputs.ios_channel }}" = "appstore" ]; then
            IOS_BUILD=$(bundle exec fastlane run app_store_build_number -q 2>/dev/null | grep -oE '[0-9]+' | tail -1 || echo "0")
          else
            IOS_BUILD=$(bundle exec fastlane run latest_testflight_build_number -q 2>/dev/null | grep -oE '[0-9]+' | tail -1 || echo "0")
          fi
          echo "IOS_STORE_BUILD_NUMBER=$IOS_BUILD" >> $GITHUB_OUTPUT

      - name: Validate Build Numbers
        run: |
          # Ensure current build number is greater than both store versions
          CURRENT_BUILD="${{ steps.read_version.outputs.BUILD_NUMBER }}"
          ANDROID_BUILD="${{ steps.android_store.outputs.ANDROID_STORE_BUILD_NUMBER }}"
          IOS_BUILD="${{ steps.ios_store.outputs.IOS_STORE_BUILD_NUMBER }}"

          echo "Current build: $CURRENT_BUILD"
          echo "Android store build: $ANDROID_BUILD"
          echo "iOS store build: $IOS_BUILD"

          if [ "$CURRENT_BUILD" -le "$ANDROID_BUILD" ] || [ "$CURRENT_BUILD" -le "$IOS_BUILD" ]; then
            echo "Error: Current build number ($CURRENT_BUILD) must be greater than both store versions (Android: $ANDROID_BUILD, iOS: $IOS_BUILD)"
            exit 1
          fi
