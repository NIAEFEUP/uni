# Validate Version Workflow
name: "Validate Version"

on:
  workflow_call:
    inputs:
      working-directory:
        required: false
        type: string
        default: ./packages/uni_app
      android_track:
        description: "Google Play track to query (beta, production)"
        required: false
        type: string
        default: beta
      ios_channel:
        description: "iOS source to query (testflight, appstore)"
        required: false
        type: string
        default: testflight
    secrets:
      google_service_account_json:
        description: "Google service account JSON for Play Console"
        required: true
      asc_json:
        description: "App Store Connect JSON"
        required: true
    outputs:
      current_version:
        description: "Version read from app_version.txt"
        value: ${{ jobs.validate.outputs.current_version }}
      build_number:
        description: "Build number parsed from version"
        value: ${{ jobs.validate.outputs.build_number }}
      android_store_build_number:
        description: "Latest Android beta build number from Play Console"
        value: ${{ jobs.validate.outputs.android_store_build_number }}
      ios_store_build_number:
        description: "Latest iOS build number from selected channel"
        value: ${{ jobs.validate.outputs.ios_store_build_number }}

jobs:
  validate:
    name: "Validate Version"
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ${{ inputs.working-directory }}
    outputs:
      current_version: ${{ steps.read_version.outputs.CURRENT_VERSION }}
      build_number: ${{ steps.read_version.outputs.BUILD_NUMBER }}
      android_store_build_number: ${{ steps.android_store.outputs.ANDROID_STORE_BUILD_NUMBER }}
      ios_store_build_number: ${{ steps.ios_store.outputs.IOS_STORE_BUILD_NUMBER }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Read Current Version
        id: read_version
        run: |
          FULL_VERSION=$(cat app_version.txt)
          echo "CURRENT_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
          BUILD_NUMBER=$(echo "$FULL_VERSION" | cut -d'+' -f2)
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT

      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
          working-directory: ${{ inputs.working-directory }}

      - name: Get Latest Android Store Version
        id: android_store
        env:
          GOOGLE_SERVICE_ACCOUNT_JSON: ${{ secrets.google_service_account_json }}
        run: |
          trap 'rm -f /tmp/google_service_account.json' EXIT
          echo "$GOOGLE_SERVICE_ACCOUNT_JSON" > /tmp/google_service_account.json
          
          cd android
          
          bundle exec fastlane get_version_code track:${{ inputs.android_track }} key_path:/tmp/google_service_account.json
          
          ANDROID_BUILD=$(cat android_version_code.txt)
          echo "Final Parsed Android Build: $ANDROID_BUILD"
          echo "ANDROID_STORE_BUILD_NUMBER=$ANDROID_BUILD" >> $GITHUB_OUTPUT

      - name: Get Latest iOS Store Version
        id: ios_store
        env:
          ASC_JSON: ${{ secrets.asc_json }}
        run: |
          trap 'rm -f /tmp/ios_api_key.json' EXIT
          echo "$ASC_JSON" > /tmp/ios_api_key.json

          cd ios
          
          bundle exec fastlane get_version_code channel:${{ inputs.ios_channel }} key_path:/tmp/ios_api_key.json
          
          IOS_BUILD=$(cat ios_build_number.txt)
          echo "Final Parsed iOS Build: $IOS_BUILD"
          echo "IOS_STORE_BUILD_NUMBER=$IOS_BUILD" >> $GITHUB_OUTPUT

      - name: Validate Build Numbers
        run: |
          CURRENT_BUILD="${{ steps.read_version.outputs.BUILD_NUMBER }}"
          ANDROID_BUILD="${{ steps.android_store.outputs.ANDROID_STORE_BUILD_NUMBER }}"
          IOS_BUILD="${{ steps.ios_store.outputs.IOS_STORE_BUILD_NUMBER }}"

          echo "Current build: $CURRENT_BUILD"
          echo "Android store build: $ANDROID_BUILD"
          echo "iOS store build: $IOS_BUILD"
          
          curr=${CURRENT_BUILD:-0}
          and=${ANDROID_BUILD:-0}
          ios=${IOS_BUILD:-0}

          if [ "$curr" -le "$and" ] || [ "$curr" -le "$ios" ]; then
            echo "Error: Current build number ($curr) must be greater than both store versions (Android: $and, iOS: $ios)"
            exit 1
          fi